use crate::database::DatabaseExecutor;
use crate::stmt::query;

/// Migrates the migration generated by `build.rs`
#[inline(always)]
pub async fn migrate<C: DatabaseExecutor>(
    conn: &C,
    db_prefix: &str,
    migrations: &[(&str, &str)],
) -> Result<(), cdk_common::database::Error> {
    query(
        r#"
           CREATE TABLE IF NOT EXISTS migrations (
               name TEXT PRIMARY KEY,
               applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
           )
           "#,
    )?
    .execute(conn)
    .await?;

    // Apply each migration if it hasnâ€™t been applied yet
    for (name, sql) in migrations {
        let basename = match name.split_once(['/', '\\']) {
            Some((prefix, basename)) => {
                if prefix != db_prefix {
                    continue;
                }
                basename
            }
            None => name,
        };

        let is_missing = query("SELECT name FROM migrations WHERE name = :name")?
            .bind("name", basename)
            .pluck(conn)
            .await?
            .is_none();

        if is_missing {
            query(sql)?.batch(conn).await?;
            query(r#"INSERT INTO migrations (name) VALUES (:name)"#)?
                .bind("name", name)
                .execute(conn)
                .await?;
        }
    }

    Ok(())
}
